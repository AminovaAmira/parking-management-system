# Исправление отображения баланса в реальном времени

## Дата: 16.12.2025

## Проблема

После создания бронирования или завершения парковки баланс пользователя не обновлялся на фронтенде до перезахода в аккаунт. Это создавало впечатление, что деньги не списываются (или происходит "дюп баланса").

**На самом деле:**
- Деньги корректно списывались/возвращались в БД
- Но в интерфейсе отображался старый баланс из контекста пользователя

## Решение

### Backend: Добавлен возврат средств при отмене бронирования

**Файл:** `backend/app/api/endpoints/bookings.py:325-380`

Ранее при отмене бронирования просто менялся статус, но деньги не возвращались. Теперь:

```python
# Return money to balance
refund_amount = booking.estimated_cost
balance_before = current_customer.balance
balance_after = balance_before + refund_amount
current_customer.balance = balance_after

# Create refund transaction
refund_transaction = Transaction(
    customer_id=current_customer.customer_id,
    booking_id=booking.booking_id,
    amount=refund_amount,
    type="refund",
    description=f"Возврат средств за отмененное бронирование",
    balance_before=balance_before,
    balance_after=balance_after
)
db.add(refund_transaction)
```

### Frontend: Добавлено обновление контекста пользователя

**Файл:** `frontend/src/pages/DashboardPage.jsx`

Добавлен вызов `await updateUser()` после всех операций с балансом:

#### 1. После создания бронирования (строка 246)
```javascript
await parkingService.createBooking(bookingData);
// Обновляем баланс пользователя после списания средств
await updateUser();
```

#### 2. После завершения сессии (строка 268)
```javascript
await parkingService.endSession(sessionId, { exit_time: exitTime });
// Обновляем баланс пользователя после возврата/штрафа
await updateUser();
```

#### 3. После отмены бронирования (строка 161)
```javascript
await parkingService.cancelBooking(bookingId);
// Обновляем баланс пользователя после возврата средств
await updateUser();
```

## Как это работает

### Функция updateUser()

Функция `updateUser()` определена в `AuthContext` и делает следующее:
1. Запрашивает актуальные данные пользователя с сервера
2. Обновляет объект `user` в контексте
3. Сохраняет обновленные данные в localStorage

Это приводит к **немедленному** обновлению отображаемого баланса во всех компонентах, использующих `useAuth()`.

## Полный цикл работы с балансом

### Сценарий 1: Создание бронирования
```
1. Баланс: 1000 ₽
2. Пользователь создает бронирование (200 ₽)
3. Backend списывает деньги → БД: баланс = 800 ₽
4. Frontend вызывает updateUser()
5. ✅ Интерфейс показывает: 800 ₽ (обновлено мгновенно)
```

### Сценарий 2: Завершение парковки с возвратом
```
1. Баланс: 800 ₽ (после бронирования на 200 ₽)
2. Пользователь завершает парковку через 1 час (фактически 100 ₽)
3. Backend возвращает 100 ₽ → БД: баланс = 900 ₽
4. Frontend вызывает updateUser()
5. ✅ Интерфейс показывает: 900 ₽ (возврат виден сразу)
```

### Сценарий 3: Завершение парковки со штрафом
```
1. Баланс: 800 ₽ (после бронирования на 200 ₽)
2. Пользователь завершает парковку через 3 часа (фактически 300 ₽)
3. Backend списывает штраф 100 ₽ → БД: баланс = 700 ₽
4. Frontend вызывает updateUser()
5. ✅ Интерфейс показывает: 700 ₽ (штраф виден сразу)
```

### Сценарий 4: Отмена бронирования
```
1. Баланс: 800 ₽ (после бронирования на 200 ₽)
2. Пользователь отменяет бронирование
3. Backend возвращает 200 ₽ → БД: баланс = 1000 ₽
4. Frontend вызывает updateUser()
5. ✅ Интерфейс показывает: 1000 ₽ (возврат виден сразу)
```

## Дополнительные улучшения

### 1. Предупреждение при отмене
Изменен текст подтверждения при отмене бронирования:
```javascript
'Отменить бронирование? Средства будут возвращены на ваш баланс.'
```

### 2. Проверка повторной отмены
Добавлена защита от повторной отмены одного и того же бронирования:
```python
if booking.status == "cancelled":
    raise HTTPException(
        status_code=status.HTTP_400_BAD_REQUEST,
        detail="Booking is already cancelled"
    )
```

## Тестирование

### Проверка обновления баланса:

1. **Создание бронирования:**
   - Запомните баланс
   - Создайте бронирование
   - ✅ Баланс должен уменьшиться СРАЗУ

2. **Отмена бронирования:**
   - Отмените созданное бронирование
   - ✅ Баланс должен вернуться СРАЗУ

3. **Завершение парковки:**
   - Создайте бронирование и начните парковку
   - Завершите парковку раньше/позже
   - ✅ Баланс должен обновиться СРАЗУ (возврат или штраф)

## Результат

✅ **Проблема решена:** Баланс теперь обновляется в реальном времени
✅ **Нет "дюпа баланса":** Все изменения баланса видны мгновенно
✅ **Прозрачность:** Пользователь всегда видит актуальный баланс
✅ **Возврат при отмене:** При отмене бронирования деньги возвращаются автоматически

## Файлы изменены

### Backend:
- `backend/app/api/endpoints/bookings.py` - добавлен возврат средств при отмене бронирования

### Frontend:
- `frontend/src/pages/DashboardPage.jsx` - добавлены вызовы updateUser() после операций с балансом
